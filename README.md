# Компонент «Зависимые поля» для Bitrix

## Разработчик:

* *Олег Ритум:* [Github](https://github.com/oritum)

  Год разработки: *2025.*

## Введение

Компонент «Зависимые поля» разработан для Bitrix CMS и позволяет создавать интерфейсы для выбора зависимых значений из различных инфоблоков. Он поддерживает несколько уровней зависимости, где выбор на одном уровне ограничивает доступные опции на следующем. Это идеально подходит для создания каскадных интерфейсов, таких, например, как выбор страны, затем региона  в этой стране и, наконец, города в регионе.

## Установка

Для установки компонента выполните следующие шаги:

1. Разместите файлы компонента в директории `local/components/oritum/dependent_fields/` вашего сайта на Bitrix. Убедитесь, что структура директорий соответствует следующей:
   * `local/components/oritum/dependent_fields/component.php`
   * `local/components/oritum/dependent_fields/.description.php`
   * `local/components/oritum/dependent_fields/.parameters.php`
   * `local/components/oritum/dependent_fields/lang/ru/.parameters.php`
   * `local/components/oritum/dependent_fields/lang/ru/.description.php`
   * `local/components/oritum/dependent_fields/templates/.default/template.php`
   * `local/components/oritum/dependent_fields/templates/.default/lang/ru/template.php`
   * `local/components/oritum/dependent_fields/templates/.default/script.js`
2. Убедитесь, что модуль "iblock" установлен и активирован в вашей системе Bitrix, так как компонент зависит от него.

После установки компонент будет доступен для добавления через визуальный редактор Bitrix или напрямую в PHP-шаблонах.

## Настройка

Компонент настраивается через параметры, которые задаются при его подключении. Доступные параметры:

| Параметр      | Описание                                                                                                                       | Тип       | Значение по умолчанию |
| --------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | ------------ | ---------------------------------------- |
| `LEVELS_COUNT`      | Количество уровней зависимости                                                                             | Число   | 3                                        |
| `LEVEL_i_NAME`      | Название уровня `i`(например, "Страна" для уровня 1)                                            | Строка | `LEVEL_i`                              |
| `LEVEL_i_IBLOCK_ID` | ID инфоблока для уровня `i`                                                                                        | Число   | -                                        |
| `LINK_PROP_LEVEL_i` | Код свойства в инфоблоке уровня `i`, связывающего с уровнем `i-1`(для `i > 1`) | Строка | -                                        |

**Важно:** Свойства связи (`LINK_PROP_LEVEL_i`) должны быть настроены в инфоблоках и иметь тип "Привязка к элементу". Например:

* Для уровня 2 свойство `LINK_PROP_LEVEL_2` в инфоблоке уровня 2 должно ссылаться на инфоблок уровня 1.
* Для уровня 3 свойство `LINK_PROP_LEVEL_3` в инфоблоке уровня 3 должно ссылаться на инфоблок уровня 2.

## Использование

Для подключения компонента используйте следующий код в вашем PHP-шаблоне:

```php
<?$APPLICATION->IncludeComponent(
	"oritum:dependent_fields",
	"",
	Array(
		"LEVELS_COUNT" => "3",
		"LEVEL_1_IBLOCK_ID" => "1",
		"LEVEL_1_NAME" => "Страна",
		"LEVEL_2_IBLOCK_ID" => "2",
		"LEVEL_2_NAME" => "Регион",
		"LEVEL_3_IBLOCK_ID" => "3",
		"LEVEL_3_NAME" => "Город",
		"LINK_PROP_LEVEL_2" => "COUNTRY",
		"LINK_PROP_LEVEL_3" => "REGION"
	)
);?>
```

### Пример

Предположим, у вас есть три инфоблока:

* Инфоблок 1 (ID: 1): Страны
* Инфоблок 2 (ID: 2): Регионы, с свойством "COUNTRY" типа "Привязка к элементу", ссылающимся на инфоблок 1
* Инфоблок 3 (ID: 3): Города, с свойством "REGION" типа "Привязка к элементу", ссылающимся на инфоблок 2

Настройте компонент следующим образом:

* `LEVELS_COUNT`: 3
* `LEVEL_1_NAME`: "Страна"
* `LEVEL_1_IBLOCK_ID`: 1
* `LEVEL_2_NAME`: "Регион"
* `LEVEL_2_IBLOCK_ID`: 2
* `LINK_PROP_LEVEL_2`: "COUNTRY"
* `LEVEL_3_NAME`: "Город"
* `LEVEL_3_IBLOCK_ID`: 3
* `LINK_PROP_LEVEL_3`: "REGION"

При выборе страны в первом выпадающем списке, во втором списке отобразятся только регионы этой страны. После выбора регионы в третьем списке появятся только города этого регионы. Выбранные элементы последнего уровня отображаются внизу формы в виде списка.

**Примечание:** Компонент использует серверную обработку и перезагрузку страницы для обновления выборов. Для более плавного взаимодействия можно рассмотреть внедрение AJAX, но это потребует модификации компонента.

## Зависимости

Компонент имеет следующие зависимости:

* Модуль "iblock" должен быть установлен и активирован в Bitrix.
* Для стилизации и клиентских взаимодействий используется Bootstrap, подключаемый через CDN ([Bootstrap CSS](https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css) и [Bootstrap JS](https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js)). Дополнительная установка Bootstrap не требуется.

## Локализация

Компонент поддерживает локализацию. Ниже приведены сообщения, которые можно перевести через языковые файлы Bitrix:

| Код сообщения               | Значение по умолчанию (RU)                                                 | Перевод (EN) (опицонально)             |
| --------------------------------------- | --------------------------------------------------------------------------------------------- | -------------------------------------------------------- |
| `COMPONENT_NAME`                      | Зависимые поля                                                                   | Dependent Fields                                         |
| `COMPONENT_DESCRIPTION`               | Компонент выбора зависимых значений из инфоблоков | Component for selecting dependent values from infoblocks |
| `COMPONENT_ID`                        | oritum                                                                                        | oritum                                                   |
| `COMPONENT_LIST_NAME`                 | Компоненты Oritum                                                                   | Oritum Components                                        |
| `DEPENDENT_FIELDS_LEVELS_COUNT_NAME`  | Количество уровней                                                           | Number of levels                                         |
| `DEPENDENT_FILEDS_LEVEL_NAME`         | Название уровня                                                                 | Level name                                               |
| `DEPENDENT_FILEDS_LEVEL_IBLOCK`       | Инфоблок уровня                                                                 | Level infoblock                                          |
| `DEPENDENT_FIELDS_LINK_PROPERTY_NAME` | Свойство связи "Уровень #TO# → Уровень #FROM#"                    | Linking property "Level #TO# → Level #FROM#"            |
| `DEPENDENT_FIELDS_SELECT`             | Выбрать                                                                                | Select                                                   |
| `DEPENDENT_FIELDS_SELECT_ALL`         | Выбрать всё                                                                         | Select all                                               |
| `DEPENDENT_FIELDS_CLEAR`              | Очистить                                                                              | Clear                                                    |
| `DEPENDENT_FIELDS_APPLY`              | Применить                                                                            | Apply                                                    |
| `DEPENDENT_FIELDS_SELECTED_ITEMS`     | Выбранные элементы:                                                          | Selected items:                                          |

Для локализации переопределите эти сообщения в языковых файлах вашего сайта.

## Дополнительные замечания

* **Стилизация:** Компонент использует Bootstrap для оформления интерфейса. Для кастомизации внешнего вида можно изменить файл `template.php`.
* **Клиентские взаимодействия:** Файл `script.js` отвечает за раскрытие выпадающих списков, функции "Выбрать всё" и "Очистить". Эти действия выполняются на стороне клиента, но не влияют на серверную логику
